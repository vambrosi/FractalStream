viewers:
  - title: Parameter space
    style: complex-plane
    size: 512x512
    resizable: true
    z-coord: C
    initial-center: 0
    initial-pixel-size: 1/128
    code: |
        z : ‚ÑÇ ‚≠† 0
        k : ‚Ñ§ ‚≠† 0
        while k < maxIters and not stop
          z ‚≠† f
          d : ‚Ñù ‚≠† |z - twist_center|
          if d > r0 and d < r1 then
            theta : ‚Ñù ‚≠† 2 pi (d - r0) / (r1 - r0)
            z ‚≠† ùëí^(ùëñ theta) (z - twist_center) + twist_center
          k ‚≠† k + 1

        if k = maxIters then
          color ‚≠† black
        else
          c1 : Color ‚≠† if im(z) > 0 then blue else yellow
          c2 : Color ‚≠† if im(z) > 0 then green else red
          s : ‚Ñù ‚≠† k + 1 - (log (log (|z|¬≤) / (2 log maxRadius))) / log 2
          s ‚≠† cos (s œÄ / 10)¬≤
          color ‚≠† blend (s, c1, c2)

  - title: Twisted dynamical plane
    style: complex-plane
    size: 512x512
    resizable: true
    z-coord: z
    pixel-size: px
    initial-center: 0
    initial-pixel-size: 1/128
    code: |
        k : ‚Ñ§ ‚≠† 0
        while k < maxIters and not stop
          z ‚≠† f
          d : ‚Ñù ‚≠† |z - twist_center|
          if d > r0 and d < r1 then
            theta : ‚Ñù ‚≠† 2œÄ (d - r0) / (r1 - r0)
            z ‚≠† ùëí^(ùëñ theta) (z - twist_center) + twist_center
          k ‚≠† k + 1

        if k = maxIters then
          color ‚≠† black
        else
          c1 : Color ‚≠† if im(z) > 0 then blue else yellow
          c2 : Color ‚≠† if im(z) > 0 then green else red
          s : ‚Ñù ‚≠† k + 1 - (log (log (|z|¬≤) / (2 log maxRadius))) / log 2
          s ‚≠† cos (s œÄ / 10)¬≤
          color ‚≠† blend (s, c1, c2)

    tools:
      - name: Trace
        shortcut: t
        actions:
          - event: deactivated
            code: erase

          - event: click-or-drag
            code: |
              prevZ : ‚ÑÇ ‚≠† z
              k : ‚Ñ§ ‚≠† 0
              erase
              while k < 100
                prevZ ‚≠† z
                draw point at z
                z ‚≠† f
                d : ‚Ñù ‚≠† |z - twist_center|
                if d > r0 and d < r1 then
                  theta : ‚Ñù ‚≠† 2œÄ (d - r0) / (r1 - r0)
                  z ‚≠† e^(ùëñ theta) (z - twist_center) + twist_center
                draw line from z to prevZ
                k ‚≠† k + 1


      - name: Dehn twist
        shortcut: d
        actions:
          - event: activated
            code: |
              use red for stroke
              draw point at twist_center
              use white for stroke
              draw circle at twist_center with radius r0
              draw circle at twist_center with radius r1
          - event: deactivated
            code: erase
          - event: drag-finished
            code: drag_target ‚≠† 0
          - event: drag
            start: z0
            code: |
              eps : ‚Ñù ‚≠† 5 px
              if drag_target = 0 then
                if |z0 - twist_center| < eps then
                  drag_target ‚≠† 1

                else if |(|z0 - twist_center|) - r0| < eps then
                  drag_target ‚≠† 2

                else if |(|z0 - twist_center|) - r1| < eps then
                  drag_target ‚≠† 3

              if drag_target = 1 then
                twist_center ‚≠† z
              if drag_target = 2 then
                r0 ‚≠† |z - twist_center|
              if drag_target = 3 then
                r1 ‚≠† |z - twist_center|
              if drag_target > 0 then
                erase
                use red for stroke
                draw point at twist_center
                use white for stroke
                draw circle at twist_center with radius r0
                draw circle at twist_center with radius r1


setup:
  title: Parametric complex dynamics
  size: 200x200
  vertical-contents:
    - text-entry:
        label: "Iterate f(z) = "
        value: "z^2 + C"
        type: ‚ÑÇ
        environment:
          z: C
          C: C
        variable: f
    - text-entry:
        label: "until"
        value: "|z| > maxRadius"
        environment:
          z: C
          C: C
          maxRadius: R
        type: Boolean
        variable: stop

configuration:
  title: Configuration
  size: 400x200
  vertical-contents:
    - text-entry:
        label: "Selected value of C:"
        value: -0.1226 + 0.7449i
        type: ‚ÑÇ
        variable: C
    - panel:
        title: "Dehn twist"
        vertical-contents:
          - text-entry:
              label: "Center of twist:"
              value: -0.267 + 0.478i
              type: ‚ÑÇ
              variable: twist_center
          - horizontal-contents:
              - text-entry:
                  label: "Inner radius"
                  value: 0.2
                  type: ‚Ñù
                  variable: r0
              - text-entry:
                  label: "Outer radius"
                  value: 0.5
                  type: ‚Ñù
                  variable: r1
    - text-entry:
        label: "Max. iterations: "
        value: "100"
        type: ‚Ñ§
        variable: maxIters
    - text-entry:
        label: "Max. radius: "
        value: 10
        type: ‚Ñù
        variable: maxRadius
    - text-entry:
        label: "Dehn tool drag target: "
        value: "0"
        type: ‚Ñ§
        variable: drag_target
